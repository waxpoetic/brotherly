language: ruby
rvm: 2.6.2
env:
  global:
    - COMPOSE_FILE_PATH=docker-compose.yml:docker-compose.test.yml
    - secure: Z2ttryjkg3gKr94PSwfQOBIotB2QGyB4NKBgboK2zRrRhdcrgqi1KT1Vkc2Hyn7DVuSMj7BWJBEN+98opkrgc/oqKiM5nS31pKy56f4vTxDwEmM8EiXnEi8ncazgu6fXkxf8zAjbEVcUEX4fp52MYn3Ct9ZonEcz281qOVYOShB8oaH6+YwQzUdx8mXPTLtTIN5QMhs+kzDug1t2DvJ0epMhOR5VyOnJMWtrEuvRNAhkh5pkDotcVokm82pj31uy+cfFa4LCXTU28FbV4QvJSJTvdI7CJORs5togBHiCjEMAyGPr59QjrV5lsi5anmvlF0N7/9UAhlGXMcDLEvLgCTAwGlSlEIXRaM7LFxiRuc3fJNdyxXKvQlsR+LcegoXO7/mG5zPI9wh7zLhGe1P5gret9LWxNeLHHZTRVCpnKcAkIrQnp70K7brNFO7B/mdbof22TabtgLfaMX7NxQlt3QBKy9ZGya3sbm7BjRfX5VZWI9UjuUwBkf30Xdf3vQtZLHbqW81WfmDR8F+V35VvB2RqKIITNSW6b8Up0XUuwnPo92SnkvpbIaUtNpt06swQRADCV2KoEStUnou77xyfJTZNdlH0qZ+4HrRzOND+QRZw4r+cht2xcl7Pxf/1C8fO/GScKnwC5WK2m83Rkeu+MEAO2HQSuaBEUpW7QvIOWJc=
services:
  - docker
install: docker-compose run web rails db:setup
before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - "./cc-test-reporter before-build"
script: docker-compose run web rspec
after_script:
  - "./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT"
before_deploy:
  - docker-compose -f docker-compose.yml -f docker-compose.production.yml build web
  - docker-compose -f docker-compose.yml -f docker-compose.production.yml build worker
  - curl https://cli-assets.heroku.com/install.sh | sh
deploy:
  - provider: script
    command:
      - docker-compose -f docker-compose.yml -f docker-compose.production.yml push web
      - docker-compose -f docker-compose.yml -f docker-compose.production.yml push worker
      - heroku container:release web worker -a brotherly
    on:
      repo: waxpoetic/brotherly
      tags: true
  - provider: script
    command:
      - docker tag registry.heroku.com/brotherly/web registry.heroku.com/brotherly-staging/web
      - docker tag registry.heroku.com/brotherly/worker registry.heroku.com/brotherly-staging/worker
      - docker push registry.heroku.com/brotherly-staging/web
      - docker push registry.heroku.com/brotherly-staging/worker
      - heroku container:release web worker -a brotherly-staging
    on:
      repo: waxpoetic/brotherly
      branch: master
